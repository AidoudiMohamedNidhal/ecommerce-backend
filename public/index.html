<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>E-commerce SimplifiÃ©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 0;
    }
    header {
      background: #222;
      color: #fff;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 20px;
    }
    header .user-info {
      font-size: 14px;
    }
    main {
      max-width: 1000px;
      margin: 20px auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    h2 {
      margin-top: 30px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 5px;
    }
    form {
      margin: 10px 0 20px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    form input {
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    form button {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      background: #007bff;
      color: #fff;
      cursor: pointer;
    }
    form button:hover {
      background: #0056b3;
    }
    .section {
      margin-bottom: 30px;
    }
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 15px;
    }
    .card {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 10px;
      background: #fafafa;
    }
    .card h3 {
      margin-top: 0;
      font-size: 16px;
    }
    /* ðŸ‘‡ NEW: style Ù„Ù„ØµÙˆØ± Ù…ØªØ§Ø¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª */
    .product-image {
      width: 100%;
      max-height: 160px;
      object-fit: cover;
      border-radius: 4px;
      margin-bottom: 8px;
      display: block;
    }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      font-size: 11px;
      border-radius: 4px;
      background: #eee;
      margin-left: 5px;
    }
    .cart-list, .orders-list {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 10px;
      background: #fafafa;
    }
    .cart-item, .order-item {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px dashed #ddd;
    }
    .cart-item:last-child, .order-item:last-child {
      border-bottom: none;
    }
    .btn-small {
      padding: 2px 6px;
      font-size: 12px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
    }
    .btn-danger {
      background: #dc3545;
      color: #fff;
    }
    .btn-secondary {
      background: #6c757d;
      color: #fff;
    }
    .info {
      font-size: 13px;
      color: #666;
    }
    .label {
      font-size: 13px;
      font-weight: bold;
    }
    .flex-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <header>
    <h1>Mini E-commerce</h1>
    <div class="user-info">
      <span id="userStatus">Non connectÃ©</span>
      <button id="btnLogout" class="btn-small btn-secondary hidden" onclick="logout()">DÃ©connexion</button>
    </div>
  </header>

  <main>
    <!-- AUTH -->
    <section class="section" id="authSection">
      <h2>Authentification</h2>
      <div class="flex-row">
        <div>
          <h3>CrÃ©er un compte</h3>
          <form id="formRegister" onsubmit="registerUser(event)">
            <input type="text" id="regName" placeholder="Nom" />
            <input type="email" id="regEmail" placeholder="Email" required />
            <input type="password" id="regPassword" placeholder="Mot de passe" required />
            <button type="submit">S'inscrire</button>
          </form>
        </div>
        <div>
          <h3>Se connecter</h3>
          <form id="formLogin" onsubmit="loginUser(event)">
            <input type="email" id="loginEmail" placeholder="Email" required />
            <input type="password" id="loginPassword" placeholder="Mot de passe" required />
            <button type="submit">Se connecter</button>
          </form>
        </div>
      </div>
      <p class="info">AprÃ¨s connexion, tu peux passer des commandes. Si ton compte a le rÃ´le ADMIN, la partie admin s'affiche.</p>
    </section>

    <!-- PRODUITS -->
    <section class="section" id="productsSection">
      <h2>Produits</h2>
      <div id="productsContainer" class="products-grid">
        <!-- produits ici -->
      </div>
    </section>

    <!-- ADMIN: CRÃ‰ER PRODUIT -->
    <section class="section hidden" id="adminSection">
      <h2>Admin - GÃ©rer les produits</h2>
      <form id="formCreateProduct" onsubmit="createProduct(event)">
        <input type="text" id="prodName" placeholder="Nom du produit" required />
        <input type="text" id="prodDesc" placeholder="Description" />
        <input type="number" step="0.01" id="prodPrice" placeholder="Prix" required />
        <input type="text" id="prodImage" placeholder="URL de l'image (optionnel)" />
        <button type="submit">Ajouter</button>
      </form>
      <p class="info">Cette section est visible uniquement si ton rÃ´le est ADMIN.</p>
    </section>

    <!-- PANIER -->
    <section class="section" id="cartSection">
      <h2>Panier</h2>
      <div id="cartContainer" class="cart-list">
        <!-- items du panier -->
      </div>
      <p><b>Total:</b> <span id="cartTotal">0</span> DT</p>
      <button onclick="placeOrder()">Valider la commande</button>
      <p class="info">Pour passer une commande, il faut Ãªtre connectÃ©.</p>
    </section>

    <!-- MES COMMANDES -->
    <section class="section" id="ordersSection">
      <h2>Mes commandes</h2>
      <button class="btn-small" onclick="loadMyOrders()">RafraÃ®chir</button>
      <div id="ordersContainer" class="orders-list">
        <!-- commandes -->
      </div>
    </section>
  </main>

  <script>
    const API_URL = window.location.origin;


    let authToken = null;
    let currentUser = null;
    let cart = [];

    // Helpers
    function setUserUI() {
      const userStatus = document.getElementById('userStatus');
      const btnLogout = document.getElementById('btnLogout');
      const adminSection = document.getElementById('adminSection');

      if (authToken && currentUser) {
        userStatus.textContent = currentUser.email + ' (' + currentUser.role + ')';
        btnLogout.classList.remove('hidden');
        // afficher section admin si role = ADMIN
        if (currentUser.role === 'ADMIN') {
          adminSection.classList.remove('hidden');
        } else {
          adminSection.classList.add('hidden');
        }
      } else {
        userStatus.textContent = 'Non connectÃ©';
        btnLogout.classList.add('hidden');
        adminSection.classList.add('hidden');
      }
    }

    function getAuthHeaders() {
      if (!authToken) return {};
      return { 'Authorization': 'Bearer ' + authToken };
    }

    // AUTH
    async function registerUser(event) {
      event.preventDefault();
      const name = document.getElementById('regName').value;
      const email = document.getElementById('regEmail').value;
      const password = document.getElementById('regPassword').value;

      try {
        const res = await fetch(API_URL + '/auth/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email, password })
        });

        if (!res.ok) {
          const err = await res.json();
          alert('Erreur inscription: ' + (err.message || res.status));
          return;
        }

        alert('Compte crÃ©Ã© ! Tu peux maintenant te connecter.');
        document.getElementById('formRegister').reset();
      } catch (e) {
        console.error(e);
        alert('Erreur rÃ©seau');
      }
    }

    async function loginUser(event) {
      event.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;

      try {
        const res = await fetch(API_URL + '/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const data = await res.json();
        if (!res.ok) {
          alert('Erreur login: ' + (data.message || res.status));
          return;
        }

        authToken = data.token;
        currentUser = data.user;
        setUserUI();
        alert('ConnectÃ© en tant que ' + currentUser.email);
      } catch (e) {
        console.error(e);
        alert('Erreur rÃ©seau');
      }
    }

    function logout() {
      authToken = null;
      currentUser = null;
      setUserUI();
      alert('DÃ©connectÃ©');
    }

    // PRODUITS
    async function loadProducts() {
      try {
        const res = await fetch(API_URL + '/products');
        const data = await res.json();

        const container = document.getElementById('productsContainer');
        container.innerHTML = '';

        data.forEach(prod => {
          const div = document.createElement('div');
          div.className = 'card';

          // ðŸ‘‡ NEW: Ù„Ùˆ Ø¹Ù†Ø¯Ùˆ ØµÙˆØ±Ø©ØŒ Ù†Ø¹Ù…Ù„ img
          let imgHtml = '';
          if (prod.image) {
            imgHtml = `<img src="${prod.image}" alt="${prod.name}" class="product-image">`;
          }

          div.innerHTML = `
            ${imgHtml}
            <h3>${prod.name}</h3>
            <p>${prod.description || ''}</p>
            <p><span class="label">Prix:</span> ${prod.price} DT</p>
            <button class="btn-small" onclick="addToCart(${prod.id}, '${prod.name.replace(/'/g, "\\'")}', ${prod.price})">
              Ajouter au panier
            </button>
          `;
          container.appendChild(div);
        });
      } catch (e) {
        console.error(e);
        alert('Erreur chargement produits');
      }
    }

    async function createProduct(event) {
      event.preventDefault();
      const name = document.getElementById('prodName').value;
      const description = document.getElementById('prodDesc').value;
      const price = parseFloat(document.getElementById('prodPrice').value);
      const image = document.getElementById('prodImage').value;

      try {
        const res = await fetch(API_URL + '/products', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...getAuthHeaders()
          },
          body: JSON.stringify({ name, description, price, image })
        });

        const data = await res.json();
        if (!res.ok) {
          alert('Erreur crÃ©ation produit: ' + (data.message || res.status));
          return;
        }

        alert('Produit crÃ©Ã© !');
        document.getElementById('formCreateProduct').reset();
        loadProducts();
      } catch (e) {
        console.error(e);
        alert('Erreur rÃ©seau');
      }
    }

    // PANIER (Front seulement)
    function addToCart(id, name, price) {
      const existing = cart.find(item => item.productId === id);
      if (existing) {
        existing.quantity += 1;
      } else {
        cart.push({ productId: id, name, price, quantity: 1 });
      }
      renderCart();
    }

    function removeFromCart(id) {
      cart = cart.filter(item => item.productId !== id);
      renderCart();
    }

    function renderCart() {
      const container = document.getElementById('cartContainer');
      const totalSpan = document.getElementById('cartTotal');

      container.innerHTML = '';
      let total = 0;

      if (cart.length === 0) {
        container.innerHTML = '<p>Panier vide</p>';
        totalSpan.textContent = '0';
        return;
      }

      cart.forEach(item => {
        const line = document.createElement('div');
        line.className = 'cart-item';
        const sousTotal = item.price * item.quantity;
        total += sousTotal;
        line.innerHTML = `
          <span>${item.name} x ${item.quantity} (${item.price} DT)</span>
          <span>
            ${sousTotal} DT
            <button class="btn-small btn-danger" onclick="removeFromCart(${item.productId})">X</button>
          </span>
        `;
        container.appendChild(line);
      });

      totalSpan.textContent = total.toFixed(2);
    }

    async function placeOrder() {
      if (!authToken || !currentUser) {
        alert('Tu dois Ãªtre connectÃ© pour passer une commande.');
        return;
      }
      if (cart.length === 0) {
        alert('Panier vide.');
        return;
      }

      const itemsPayload = cart.map(item => ({
        productId: item.productId,
        quantity: item.quantity
      }));

      try {
        const res = await fetch(API_URL + '/orders', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...getAuthHeaders()
          },
          body: JSON.stringify({ items: itemsPayload })
        });

        const data = await res.json();
        if (!res.ok) {
          alert('Erreur commande: ' + (data.message || res.status));
          return;
        }

        alert('Commande crÃ©Ã©e avec succÃ¨s !');
        cart = [];
        renderCart();
        loadMyOrders();
      } catch (e) {
        console.error(e);
        alert('Erreur rÃ©seau');
      }
    }

    // MES COMMANDES
    async function loadMyOrders() {
      if (!authToken || !currentUser) {
        alert('Tu dois Ãªtre connectÃ©.');
        return;
      }

      try {
        const res = await fetch(API_URL + '/orders/my', {
          headers: {
            ...getAuthHeaders()
          }
        });

        const data = await res.json();
        const container = document.getElementById('ordersContainer');
        container.innerHTML = '';

        if (!Array.isArray(data) || data.length === 0) {
          container.innerHTML = '<p>Aucune commande.</p>';
          return;
        }

        data.forEach(order => {
          const div = document.createElement('div');
          div.className = 'order-item';
          const total = order.total.toFixed(2);
          const items = order.items
            .map(it => `${it.product.name} x ${it.quantity}`)
            .join(', ');

          div.innerHTML = `
            <div>
              <b>Commande #${order.id}</b> - ${total} DT<br/>
              <span class="info">${new Date(order.createdAt).toLocaleString()}</span><br/>
              <span>${items}</span>
            </div>
          `;
          container.appendChild(div);
        });
      } catch (e) {
        console.error(e);
        alert('Erreur chargement commandes');
      }
    }

    // INIT
    window.addEventListener('DOMContentLoaded', () => {
      setUserUI();
      loadProducts();
      renderCart();
    });
  </script>
</body>
</html>
